<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>College Explorer ‚Äî Live IPEDS API</title>
<script crossorigin src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
<script crossorigin src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet" />
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: #0f0f1e; color: #fff; font-family: 'Segoe UI', system-ui, sans-serif; min-height: 100vh; }
  input, select, button { font-family: inherit; }
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: #0f0f1e; }
  ::-webkit-scrollbar-thumb { background: #2a2a4a; border-radius: 3px; }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  .header { background: linear-gradient(180deg, #12122a 0%, #0f0f1e 100%); border-bottom: 1px solid #1e1e3a; padding: 24px 32px 20px; }
  .header-inner { max-width: 1100px; margin: 0 auto; }
  .title-row { display: flex; align-items: baseline; gap: 12px; margin-bottom: 4px; }
  .title-row h1 { font-size: 28px; font-family: 'Playfair Display', serif; color: #fff; letter-spacing: -0.5px; }
  .title-row h1 span { color: #8ab4e8; }
  .title-row .badge-ipeds { font-size: 11px; color: #555; text-transform: uppercase; letter-spacing: 1.5px; }
  .subtitle { color: #666; font-size: 13px; margin-bottom: 18px; }

  /* Search */
  .search-wrap { position: relative; margin-bottom: 16px; }
  .search-wrap .icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #555; font-size: 18px; pointer-events: none; }
  .search-wrap input {
    width: 100%; padding: 12px 40px 12px 40px;
    background: #1a1a2e; border: 1px solid #2a2a4a; border-radius: 10px;
    color: #fff; font-size: 14px; outline: none; transition: border-color .2s;
  }
  .search-wrap input:focus { border-color: #8ab4e8; }
  .search-wrap input::placeholder { color: #4a4a5a; }
  .search-wrap .searching {
    position: absolute; right: 14px; top: 50%; transform: translateY(-50%);
  }
  .search-wrap .mini-spinner {
    width: 16px; height: 16px; border: 2px solid #2a2a4a;
    border-top-color: #8ab4e8; border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  /* Loading & Error */
  .loading, .error-box { text-align: center; padding: 60px 20px; }
  .loading .spinner { 
    display: inline-block; width: 50px; height: 50px; 
    border: 5px solid #2a2a4a; border-top-color: #8ab4e8; 
    border-radius: 50%; animation: spin 1s linear infinite; 
    margin-bottom: 20px; 
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading p { color: #8ab4e8; font-size: 16px; }
  .error-box { color: #e07a5f; }
  .error-box .icon { font-size: 48px; margin-bottom: 16px; }
  .error-box p { font-size: 16px; margin-bottom: 12px; }
  .error-box button { 
    background: #2a2a4a; border: 1px solid #3a3a5a; 
    color: #fff; padding: 10px 24px; border-radius: 8px; 
    cursor: pointer; font-size: 14px; margin-top: 12px;
  }
  .error-box button:hover { background: #3a3a5a; }

  /* Info banner */
  .info-banner { 
    background: #1a2a3a; border: 1px solid #2a4a5a; 
    border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; 
  }
  .info-banner p { color: #7a9aaa; font-size: 12px; line-height: 1.5; }
  .info-banner strong { color: #8ab4e8; }
  .info-banner .api-status { 
    display: inline-block; width: 8px; height: 8px; 
    border-radius: 50%; background: #81b29a; 
    margin-right: 6px; animation: pulse 2s infinite;
  }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

  /* Filters */
  .filters { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
  .filters select {
    padding: 6px 28px 6px 12px; background: #1a1a2e;
    border: 1px solid #2a2a4a; border-radius: 8px;
    color: #aaa; font-size: 13px; cursor: pointer; outline: none;
  }
  .filters select option { background: #1a1a2e; color: #ccc; }
  .view-toggle { display: flex; gap: 4px; margin-left: auto; }
  .view-toggle button {
    padding: 6px 14px; background: #1a1a2e; border: 1px solid #2a2a4a;
    border-radius: 8px; color: #777; font-size: 12px; cursor: pointer;
    text-transform: capitalize; transition: background .15s, color .15s;
  }
  .view-toggle button.active { background: #2a3a5a; color: #fff; }
  .result-count { margin-top: 12px; font-size: 12px; color: #555; }
  .result-count strong { color: #8ab4e8; }

  /* ‚îÄ‚îÄ Grid ‚îÄ‚îÄ */
  .content { max-width: 1100px; margin: 0 auto; padding: 24px 32px 60px; }
  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(310px, 1fr)); gap: 16px; }
  .card {
    background: #161628; border: 1px solid #1e1e3a; border-radius: 14px;
    padding: 20px; cursor: pointer; transition: border-color .2s, transform .2s, box-shadow .2s;
  }
  .card:hover { border-color: #8ab4e8; transform: translateY(-2px); box-shadow: 0 8px 30px rgba(138,180,232,0.1); }
  .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
  .card-top .loc { font-size: 11px; color: #666; }
  .card h3 { font-size: 17px; color: #fff; font-family: 'Playfair Display', serif; margin-bottom: 4px; }
  .card .sub { font-size: 12px; color: #666; margin-bottom: 14px; }

  .stats-row { display: flex; gap: 12px; margin-bottom: 14px; padding: 10px 0; border-top: 1px solid #1e1e3a; border-bottom: 1px solid #1e1e3a; }
  .stat { flex: 1; text-align: center; }
  .stat .lbl { font-size: 10px; color: #666; text-transform: uppercase; letter-spacing: .8px; }
  .stat .val { font-size: 17px; font-weight: 700; }
  .val.red { color: #e07a5f; } .val.amber { color: #e8c547; } .val.green { color: #81b29a; } .val.blue { color: #7eb8da; }

  .test-row { display: flex; justify-content: space-between; font-size: 11px; color: #777; margin-bottom: 10px; }
  .test-row strong { color: #e8c547; }

  .tags { display: flex; flex-wrap: wrap; gap: 5px; }
  .tag { font-size: 10px; color: #7a8aaa; background: #1a1a2e; padding: 2px 8px; border-radius: 10px; border: 1px solid #2a2a3a; }

  /* ‚îÄ‚îÄ Badge ‚îÄ‚îÄ */
  .badge {
    display: inline-block; padding: 2px 8px; border-radius: 12px;
    color: #fff; font-size: 10px; font-weight: 600; letter-spacing: .5px; text-transform: uppercase;
  }
  .badge-private { background: #3a2a5a; }
  .badge-public { background: #2a5a3a; }
  .badge-region { background: #2a3a4a; }

  /* ‚îÄ‚îÄ Empty ‚îÄ‚îÄ */
  .empty { text-align: center; padding: 80px 0; color: #555; }
  .empty .icon2 { font-size: 40px; margin-bottom: 12px; }
  .empty p { font-size: 16px; }

  /* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
  .modal-bg {
    position: fixed; inset: 0; background: rgba(0,0,0,0.7);
    z-index: 1000; display: flex; align-items: center; justify-content: center;
    backdrop-filter: blur(4px);
  }
  .modal {
    background: #16162a; border-radius: 16px; max-width: 720px; width: 90vw;
    max-height: 85vh; overflow-y: auto; padding: 32px; position: relative;
    border: 1px solid #2a2a4a; box-shadow: 0 24px 80px rgba(0,0,0,0.5);
  }
  .modal-close {
    position: absolute; top: 12px; right: 16px; background: none; border: none;
    color: #888; font-size: 22px; cursor: pointer; line-height: 1;
  }
  .modal-close:hover { color: #fff; }
  .modal h2 { font-size: 24px; font-family: 'Playfair Display', serif; color: #fff; margin: 8px 0 4px; }
  .modal .meta { color: #7a8aaa; font-size: 13px; margin-bottom: 24px; }

  .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 24px; }
  .stat-box { background: #1e1e36; border-radius: 10px; padding: 14px 16px; border: 1px solid #2a2a4a; }
  .stat-box .lbl2 { color: #8ab4e8; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
  .stat-box .val2 { color: #fff; font-size: 20px; font-weight: 700; }
  .stat-box .sub2 { color: #666; font-size: 11px; }

  .section-title { font-size: 13px; text-transform: uppercase; letter-spacing: 1px; margin: 20px 0 12px; font-weight: 600; }
  .section-title.blue { color: #8ab4e8; }

  .data-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #1e1e3a; }
  .data-row .label { color: #888; font-size: 13px; }
  .data-row .value { color: #fff; font-size: 13px; font-weight: 600; }

  /* Footer */
  .footer { text-align: center; padding: 16px; border-top: 1px solid #1a1a2a; font-size: 11px; color: #3a3a4a; }
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

// State to Region mapping
const STATE_REGIONS = {
  "MA": "Northeast", "CT": "Northeast", "NY": "Northeast", "PA": "Northeast", 
  "NJ": "Northeast", "RI": "Northeast", "NH": "Northeast", "VT": "Northeast", "ME": "Northeast",
  "NC": "Southeast", "GA": "Southeast", "FL": "Southeast", "VA": "Southeast", 
  "SC": "Southeast", "TN": "Southeast", "AL": "Southeast", "MS": "Southeast", "LA": "Southeast",
  "IL": "Midwest", "OH": "Midwest", "MI": "Midwest", "WI": "Midwest", "IN": "Midwest",
  "MN": "Midwest", "IA": "Midwest", "MO": "Midwest", "KS": "Midwest", "NE": "Midwest",
  "CA": "West", "WA": "West", "OR": "West", "NV": "West", "AZ": "West",
  "UT": "West", "CO": "West", "ID": "West", "MT": "West", "WY": "West",
  "TX": "South", "OK": "South", "AR": "South", "NM": "South",
  "DC": "Northeast", "MD": "Northeast", "DE": "Northeast"
};

function getRegion(state) {
  return STATE_REGIONS[state] || "Other";
}

function admColor(r){ 
  if (!r) return "green";
  return r < 0.15 ? "red" : r < 0.35 ? "amber" : "green"; 
}

// Custom debounce hook
function useDebounce(value, delay) {
  const [debouncedValue, setDebouncedValue] = useState(value);

  useEffect(() => {
    const handler = setTimeout(() => {
      setDebouncedValue(value);
    }, delay);

    return () => {
      clearTimeout(handler);
    };
  }, [value, delay]);

  return debouncedValue;
}

/* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
function Modal({college:c, onClose}){
  return <div className="modal-bg" onClick={onClose}>
    <div className="modal" onClick={e=>e.stopPropagation()}>
      <button className="modal-close" onClick={onClose}>‚úï</button>
      <div style={{display:"flex",gap:10,marginBottom:8}}>
        <span className={"badge "+(c.ownership==="Public"?"badge-public":"badge-private")}>{c.ownership}</span>
        <span className="badge badge-region">{c.region}</span>
      </div>
      <h2>{c.name}</h2>
      <p className="meta">{c.city}, {c.state} ¬∑ {c.url || 'N/A'}</p>

      {/* Top stats */}
      <div className="stat-grid">
        <div className="stat-box">
          <div className="lbl2">Admission Rate</div>
          <div className="val2">{c.admissionRate ? (c.admissionRate * 100).toFixed(1) + '%' : 'N/A'}</div>
          <div className="sub2">{c.size ? c.size.toLocaleString() + ' enrolled' : ''}</div>
        </div>
        <div className="stat-box">
          <div className="lbl2">Avg Cost/Year</div>
          <div className="val2">{c.avgCost ? '$' + c.avgCost.toLocaleString() : 'N/A'}</div>
          <div className="sub2">After aid</div>
        </div>
        <div className="stat-box">
          <div className="lbl2">Median Earnings</div>
          <div className="val2">{c.earnings ? '$' + c.earnings.toLocaleString() : 'N/A'}</div>
          <div className="sub2">6 years after entry</div>
        </div>
      </div>

      {/* Additional details */}
      <div className="section-title blue">Institution Details</div>
      
      {c.satAvg && (
        <div className="data-row">
          <span className="label">SAT Average</span>
          <span className="value">{c.satAvg}</span>
        </div>
      )}
      
      {c.actMedian && (
        <div className="data-row">
          <span className="label">ACT Median</span>
          <span className="value">{c.actMedian}</span>
        </div>
      )}
      
      {c.completionRate && (
        <div className="data-row">
          <span className="label">Completion Rate</span>
          <span className="value">{(c.completionRate * 100).toFixed(1)}%</span>
        </div>
      )}
      
      {c.retentionRate && (
        <div className="data-row">
          <span className="label">Retention Rate</span>
          <span className="value">{(c.retentionRate * 100).toFixed(1)}%</span>
        </div>
      )}
      
      {c.tuition && (
        <div className="data-row">
          <span className="label">In-State Tuition</span>
          <span className="value">${c.tuition.toLocaleString()}</span>
        </div>
      )}
      
      {c.tuitionOutState && (
        <div className="data-row">
          <span className="label">Out-of-State Tuition</span>
          <span className="value">${c.tuitionOutState.toLocaleString()}</span>
        </div>
      )}
    </div>
  </div>;
}

/* ‚îÄ‚îÄ Transform API Data ‚îÄ‚îÄ */
function transformCollegeData(school, index) {
  const ownership = school["school.ownership"] === 1 ? "Public" : 
                   school["school.ownership"] === 2 ? "Private Nonprofit" : 
                   school["school.ownership"] === 3 ? "Private For-Profit" : "Unknown";
  
  const carnegieBasic = school["school.carnegie_basic"];
  const isResearch = carnegieBasic === 15 || carnegieBasic === 16 || carnegieBasic === 17;
  
  return {
    id: school.id || index,
    name: school["school.name"],
    city: school["school.city"],
    state: school["school.state"],
    region: getRegion(school["school.state"]),
    url: school["school.school_url"],
    ownership: ownership,
    type: isResearch ? `${ownership.split(' ')[0]} Research` : ownership,
    carnegieBasic: carnegieBasic,
    locale: school["school.locale"],
    admissionRate: school["2022.admissions.admission_rate.overall"],
    satAvg: school["2022.admissions.sat_scores.average.overall"],
    actMedian: school["2022.admissions.act_scores.midpoint.cumulative"],
    size: school["2022.student.size"],
    avgCost: school["2022.cost.avg_net_price.overall"],
    tuition: school["2022.cost.tuition.in_state"],
    tuitionOutState: school["2022.cost.tuition.out_of_state"],
    completionRate: school["2022.completion.completion_rate_4yr_150nt"],
    retentionRate: school["2022.student.retention_rate_suppressed.four_year.full_time"],
    earnings: school["2022.earnings.6_yrs_after_entry.median"]
  };
}

/* ‚îÄ‚îÄ App ‚îÄ‚îÄ */
function App(){
  const [colleges, setColleges] = useState([]);
  const [loading, setLoading] = useState(true);
  const [searching, setSearching] = useState(false);
  const [error, setError] = useState(null);
  const [search, setSearch] = useState("");
  const [region, setRegion] = useState("All Regions");
  const [type, setType] = useState("All Types");
  const [sortBy, setSortBy] = useState("name");
  const [view, setView] = useState("grid");
  const [sel, setSel] = useState(null);
  const searchRef = useRef(null);

  // Debounce search with 500ms delay
  const debouncedSearch = useDebounce(search, 500);

  // Fetch colleges function
  const fetchColleges = useCallback(async (searchQuery = "") => {
    try {
      // Show appropriate loading state
      if (searchQuery && searchQuery.length >= 3) {
        setSearching(true);
      } else if (!searchQuery) {
        setLoading(true);
      }
      setError(null);

      // Call the API endpoint
      const url = searchQuery && searchQuery.length >= 3
        ? `/api/colleges?q=${encodeURIComponent(searchQuery)}`
        : '/api/colleges';

      const response = await fetch(url);
      
      if (!response.ok) {
        throw new Error(`API Error: ${response.status}`);
      }

      const data = await response.json();
      
      // Transform the results
      const transformedColleges = (data.results || []).map((school, index) => 
        transformCollegeData(school, index)
      );

      setColleges(transformedColleges);
      setLoading(false);
      setSearching(false);
    } catch (err) {
      console.error("Error fetching colleges:", err);
      setError(err.message);
      setLoading(false);
      setSearching(false);
    }
  }, []);

  // Initial load - fetch popular/top colleges
  useEffect(() => {
    fetchColleges();
  }, [fetchColleges]);

  // Debounced search effect
  useEffect(() => {
    if (debouncedSearch !== search) return; // Only run when debounced value matches
    
    if (debouncedSearch.length >= 3) {
      fetchColleges(debouncedSearch);
    } else if (debouncedSearch.length === 0) {
      fetchColleges(); // Reset to default when search is cleared
    }
  }, [debouncedSearch, search, fetchColleges]);

  // Filter and sort colleges (client-side filtering for region/type)
  const filtered = colleges.filter(c => {
    const matchRegion = region === "All Regions" || c.region === region;
    const matchType = type === "All Types" || 
                      (type === "Public" && c.ownership === "Public") ||
                      (type === "Private" && c.ownership.includes("Private"));
    return matchRegion && matchType;
  }).sort((a, b) => {
    if (sortBy === "name") return a.name.localeCompare(b.name);
    if (sortBy === "admRate") return (a.admissionRate || 1) - (b.admissionRate || 1);
    if (sortBy === "cost") return (a.avgCost || 999999) - (b.avgCost || 999999);
    if (sortBy === "earnings") return (b.earnings || 0) - (a.earnings || 0);
    return 0;
  });

  const REGIONS = ["All Regions", "Northeast", "Southeast", "Midwest", "West", "South"];
  const TYPES = ["All Types", "Public", "Private"];
  const SORTS = [
    {v:"name", l:"Name"},
    {v:"admRate", l:"Admission Rate"},
    {v:"cost", l:"Cost (Low‚ÜíHigh)"},
    {v:"earnings", l:"Earnings (High‚ÜíLow)"}
  ];

  if (loading) {
    return <div className="loading">
      <div className="spinner"></div>
      <p>Loading colleges from IPEDS database...</p>
    </div>;
  }

  if (error) {
    return <div className="error-box">
      <div className="icon">‚ö†Ô∏è</div>
      <p>Error loading data: {error}</p>
      <button onClick={() => fetchColleges()}>Retry</button>
    </div>;
  }

  return <>
    {/* Header */}
    <div className="header">
      <div className="header-inner">
        <div className="title-row">
          <h1><span>College</span> Explorer</h1>
          <span className="badge-ipeds">Live IPEDS API</span>
        </div>
        <p className="subtitle">Real-time data from the U.S. Department of Education College Scorecard</p>
        
        <div className="info-banner">
          <p>
            <span className="api-status"></span>
            <strong>Live Data:</strong> Type 3+ characters to search. Results update automatically with 500ms debounce.
          </p>
        </div>
        
        <div className="search-wrap">
          <span className="icon">‚åï</span>
          <input 
            ref={searchRef} 
            type="text" 
            placeholder="Search by school name (e.g., Harvard, MIT, Stanford)..." 
            value={search} 
            onChange={e => setSearch(e.target.value)}
          />
          {searching && (
            <div className="searching">
              <div className="mini-spinner"></div>
            </div>
          )}
        </div>
        
        <div className="filters">
          <select value={region} onChange={e => setRegion(e.target.value)}>
            {REGIONS.map(r => <option key={r} value={r}>{r}</option>)}
          </select>
          <select value={type} onChange={e => setType(e.target.value)}>
            {TYPES.map(t => <option key={t} value={t}>{t}</option>)}
          </select>
          <select value={sortBy} onChange={e => setSortBy(e.target.value)}>
            {SORTS.map(s => <option key={s.v} value={s.v}>{s.l}</option>)}
          </select>
          <div className="view-toggle">
            <button 
              className={view === "grid" ? "active" : ""} 
              onClick={() => setView("grid")}
            >
              Grid
            </button>
            <button 
              className={view === "list" ? "active" : ""} 
              onClick={() => setView("list")}
            >
              List
            </button>
          </div>
        </div>
        
        <div className="result-count">
          Showing <strong>{filtered.length}</strong> colleges
          {search && search.length >= 3 && <span> matching "{search}"</span>}
        </div>
      </div>
    </div>

    {/* Content */}
    <div className="content">
      <div className="grid">
        {filtered.map(c => (
          <div key={c.id} className="card" onClick={() => setSel(c)}>
            <div className="card-top">
              <span className={"badge " + (c.ownership === "Public" ? "badge-public" : "badge-private")}>
                {c.ownership}
              </span>
              <span className="loc">{c.city}, {c.state}</span>
            </div>
            <h3>{c.name}</h3>
            <p className="sub">{c.state} ¬∑ {c.region}</p>
            
            <div className="stats-row">
              <div className="stat">
                <div className="lbl">Adm. Rate</div>
                <div className={"val " + admColor(c.admissionRate)}>
                  {c.admissionRate ? (c.admissionRate * 100).toFixed(1) + '%' : 'N/A'}
                </div>
              </div>
              <div className="stat">
                <div className="lbl">Avg Cost</div>
                <div className="val green">
                  {c.avgCost ? '$' + (c.avgCost / 1000).toFixed(0) + 'K' : 'N/A'}
                </div>
              </div>
              <div className="stat">
                <div className="lbl">Earnings</div>
                <div className="val blue">
                  {c.earnings ? '$' + (c.earnings / 1000).toFixed(0) + 'K' : 'N/A'}
                </div>
              </div>
            </div>
            
            {(c.satAvg || c.actMedian) && (
              <div className="test-row">
                {c.satAvg && <span>SAT <strong>{c.satAvg}</strong></span>}
                {c.actMedian && <span>ACT <strong>{c.actMedian}</strong></span>}
              </div>
            )}
            
            <div className="tags">
              {c.size && <span className="tag">{c.size.toLocaleString()} students</span>}
              {c.completionRate && (
                <span className="tag">{(c.completionRate * 100).toFixed(0)}% completion</span>
              )}
            </div>
          </div>
        ))}
      </div>
      
      {filtered.length === 0 && (
        <div className="empty">
          <div className="icon2">üéì</div>
          <p>
            {search && search.length < 3 
              ? "Type at least 3 characters to search" 
              : "No colleges found. Try a different search."}
          </p>
        </div>
      )}
    </div>

    {sel && <Modal college={sel} onClose={() => setSel(null)} />}
    
    <div className="footer">
      Data from College Scorecard API (IPEDS/Federal sources) ¬∑ Debounced search (500ms)
    </div>
  </>;
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
